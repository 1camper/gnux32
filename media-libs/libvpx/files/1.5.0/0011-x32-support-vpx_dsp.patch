From 434f6838020e7c3524ec32f4454a1f34bb910692 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Matthias=20R=C3=A4ncker?= <theonetruecamper@gmx.de>
Date: Sun, 9 Sep 2018 22:53:31 +0200
Subject: [PATCH 11/17] x32 support: vpx_dsp
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Matthias RÃ¤ncker <theonetruecamper@gmx.de>
Change-Id: Idd3de914c3ec111ce36301b6a95a2364690c83a3
---
 vpx_dsp/x86/highbd_intrapred_sse2.asm            | 12 ++++
 vpx_dsp/x86/highbd_sad4d_sse2.asm                | 10 ++--
 vpx_dsp/x86/highbd_subpel_variance_impl_sse2.asm | 70 ++++++++++++++----------
 vpx_dsp/x86/intrapred_sse2.asm                   | 26 +++++++++
 vpx_dsp/x86/intrapred_ssse3.asm                  | 13 +++++
 vpx_dsp/x86/inv_wht_sse2.asm                     |  1 +
 vpx_dsp/x86/sad4d_sse2.asm                       | 16 +++---
 vpx_dsp/x86/ssim_opt_x86_64.asm                  | 12 ++--
 vpx_dsp/x86/subpel_variance_sse2.asm             | 10 ++++
 vpx_dsp/x86/subtract_sse2.asm                    | 12 ++--
 vpx_dsp/x86/vpx_convolve_copy_sse2.asm           |  2 +
 vpx_dsp/x86/vpx_subpixel_8t_ssse3.asm            | 10 ++++
 12 files changed, 140 insertions(+), 54 deletions(-)

diff --git a/vpx_dsp/x86/highbd_intrapred_sse2.asm b/vpx_dsp/x86/highbd_intrapred_sse2.asm
index b12d29c0a..09f28caa4 100644
--- a/vpx_dsp/x86/highbd_intrapred_sse2.asm
+++ b/vpx_dsp/x86/highbd_intrapred_sse2.asm
@@ -21,6 +21,7 @@ INIT_MMX sse
 cglobal highbd_dc_predictor_4x4, 4, 5, 4, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   movq                  m0, [aboveq]
   movq                  m2, [leftq]
   DEFINE_ARGS dst, stride, one
@@ -48,6 +49,7 @@ INIT_XMM sse2
 cglobal highbd_dc_predictor_8x8, 4, 5, 4, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   mova                  m0, [aboveq]
   mova                  m2, [leftq]
@@ -83,6 +85,7 @@ INIT_XMM sse2
 cglobal highbd_dc_predictor_16x16, 4, 5, 5, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   mova                  m0, [aboveq]
   mova                  m3, [aboveq+16]
@@ -127,6 +130,7 @@ INIT_XMM sse2
 cglobal highbd_dc_predictor_32x32, 4, 5, 9, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   mova                  m0, [aboveq]
   mova                  m2, [aboveq+16]
@@ -185,6 +189,7 @@ cglobal highbd_dc_predictor_32x32, 4, 5, 9, dst, stride, above, left, goffset
 
 INIT_MMX sse
 cglobal highbd_v_predictor_4x4, 3, 3, 1, dst, stride, above
+  movsxdifnidn     strideq, stridep
   movq                  m0, [aboveq]
   movq    [dstq          ], m0
   movq    [dstq+strideq*2], m0
@@ -195,6 +200,7 @@ cglobal highbd_v_predictor_4x4, 3, 3, 1, dst, stride, above
 
 INIT_XMM sse2
 cglobal highbd_v_predictor_8x8, 3, 3, 1, dst, stride, above
+  movsxdifnidn     strideq, stridep
   mova                  m0, [aboveq]
   DEFINE_ARGS dst, stride, stride3
   lea             stride3q, [strideq*3]
@@ -211,6 +217,7 @@ cglobal highbd_v_predictor_8x8, 3, 3, 1, dst, stride, above
 
 INIT_XMM sse2
 cglobal highbd_v_predictor_16x16, 3, 4, 2, dst, stride, above
+  movsxdifnidn     strideq, stridep
   mova                  m0, [aboveq]
   mova                  m1, [aboveq+16]
   DEFINE_ARGS dst, stride, stride3, nlines4
@@ -232,6 +239,7 @@ cglobal highbd_v_predictor_16x16, 3, 4, 2, dst, stride, above
 
 INIT_XMM sse2
 cglobal highbd_v_predictor_32x32, 3, 4, 4, dst, stride, above
+  movsxdifnidn     strideq, stridep
   mova                  m0, [aboveq]
   mova                  m1, [aboveq+16]
   mova                  m2, [aboveq+32]
@@ -263,6 +271,7 @@ cglobal highbd_v_predictor_32x32, 3, 4, 4, dst, stride, above
 
 INIT_MMX sse
 cglobal highbd_tm_predictor_4x4, 5, 6, 5, dst, stride, above, left, bps, one
+  movsxdifnidn     strideq, stridep
   movd                  m1, [aboveq-2]
   movq                  m0, [aboveq]
   pshufw                m1, m1, 0x0
@@ -301,6 +310,7 @@ cglobal highbd_tm_predictor_4x4, 5, 6, 5, dst, stride, above, left, bps, one
 
 INIT_XMM sse2
 cglobal highbd_tm_predictor_8x8, 5, 6, 5, dst, stride, above, left, bps, one
+  movsxdifnidn     strideq, stridep
   movd                  m1, [aboveq-2]
   mova                  m0, [aboveq]
   pshuflw               m1, m1, 0x0
@@ -346,6 +356,7 @@ cglobal highbd_tm_predictor_8x8, 5, 6, 5, dst, stride, above, left, bps, one
 %if ARCH_X86_64
 INIT_XMM sse2
 cglobal highbd_tm_predictor_16x16, 5, 6, 9, dst, stride, above, left, bps, one
+  movsxdifnidn     strideq, stridep
   movd                  m2, [aboveq-2]
   mova                  m0, [aboveq]
   mova                  m1, [aboveq+16]
@@ -400,6 +411,7 @@ cglobal highbd_tm_predictor_16x16, 5, 6, 9, dst, stride, above, left, bps, one
 
 INIT_XMM sse2
 cglobal highbd_tm_predictor_32x32, 5, 6, 12, dst, stride, above, left, bps, one
+  movsxdifnidn     strideq, stridep
   movd                  m0, [aboveq-2]
   mova                  m1, [aboveq]
   mova                  m2, [aboveq+16]
diff --git a/vpx_dsp/x86/highbd_sad4d_sse2.asm b/vpx_dsp/x86/highbd_sad4d_sse2.asm
index 6c2a61e01..cb3ba1479 100644
--- a/vpx_dsp/x86/highbd_sad4d_sse2.asm
+++ b/vpx_dsp/x86/highbd_sad4d_sse2.asm
@@ -231,10 +231,10 @@ cglobal highbd_sad%1x%2x4d, 4, 7, 8, src, src_stride, ref1, ref_stride, \
 
   movsxdifnidn src_strideq, src_strided
   movsxdifnidn ref_strideq, ref_strided
-  mov                ref2q, [ref1q+gprsize*1]
-  mov                ref3q, [ref1q+gprsize*2]
-  mov                ref4q, [ref1q+gprsize*3]
-  mov                ref1q, [ref1q+gprsize*0]
+  mov                ref2p, [ref1q+ptrsize*1]
+  mov                ref3p, [ref1q+ptrsize*2]
+  mov                ref4p, [ref1q+ptrsize*3]
+  mov                ref1p, [ref1q+ptrsize*0]
 
 ; convert byte pointers to short pointers
   shl                 srcq, 1
@@ -265,7 +265,7 @@ cglobal highbd_sad%1x%2x4d, 4, 7, 8, src, src_stride, ref1, ref_stride, \
   paddd                 m4, m0
   paddd                 m6, m1
   punpcklqdq            m4, m6
-  movifnidn             r4, r4mp
+  movifnidn            r4p, r4mx
   movu                [r4], m4
   RET
 %endmacro
diff --git a/vpx_dsp/x86/highbd_subpel_variance_impl_sse2.asm b/vpx_dsp/x86/highbd_subpel_variance_impl_sse2.asm
index 93df92a9e..7c4cb5ead 100644
--- a/vpx_dsp/x86/highbd_subpel_variance_impl_sse2.asm
+++ b/vpx_dsp/x86/highbd_subpel_variance_impl_sse2.asm
@@ -70,7 +70,7 @@ SECTION .text
   pshufd               m4, m6, 0x1
   paddd                m7, m3
   paddd                m6, m4
-  mov                  r1, ssem         ; r1 = unsigned int *sse
+  mov                 r1p, ssemx        ; r1 = unsigned int *sse
   movd               [r1], m7           ; store sse
   movd                rax, m6           ; store sum as return value
 %endif
@@ -79,7 +79,8 @@ SECTION .text
 
 %macro INC_SRC_BY_SRC_STRIDE  0
 %if ARCH_X86=1 && CONFIG_PIC=1
-  lea                srcq, [srcq + src_stridemp*2]
+  add                srcp, src_stridemx
+  add                srcp, src_stridemx
 %else
   lea                srcq, [srcq + src_strideq*2]
 %endif
@@ -104,13 +105,19 @@ SECTION .text
                                       x_offset, y_offset, \
                                       dst, dst_stride, \
                                       sec, sec_stride, height, sse
-    %define sec_str sec_strideq
+    %define sec_str sec_stridep
+    %if ABI_X32
+      mov        secp, secp
+    %endif
   %else
     cglobal highbd_sub_pixel_variance%1xh, 7, 8, 13, src, src_stride, x_offset, \
                                   y_offset, dst, dst_stride, height, sse
   %endif
   %define block_height heightd
   %define bilin_filter sseq
+  %if ABI_X32
+    mov        ssep, ssep
+  %endif
 %else
   %if ARCH_X86=1 && CONFIG_PIC=1
     %if %2 == 1 ; avg
@@ -176,6 +183,9 @@ SECTION .text
   %endif
 %endif
 
+  movsxdifnidn src_strideq, src_stridep
+  movsxdifnidn dst_strideq, dst_stridep
+
   ASSERT               %1 <= 16         ; m6 overflows if w > 16
   pxor                 m6, m6           ; sum
   pxor                 m7, m7           ; sse
@@ -210,7 +220,7 @@ SECTION .text
   lea                srcq, [srcq + src_strideq*2]
   lea                dstq, [dstq + dst_strideq*2]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %else ; %1 < 16
   movu                 m0, [srcq]
@@ -219,7 +229,7 @@ SECTION .text
   mova                 m3, [dstq + dst_strideq*2]
 %if %2 == 1 ; avg
   pavgw                m0, [secq]
-  add                secq, sec_str
+  add                secp, sec_str
   pavgw                m2, [secq]
 %endif
   SUM_SSE              m0, m1, m2, m3, m6, m7
@@ -227,7 +237,7 @@ SECTION .text
   lea                srcq, [srcq + src_strideq*4]
   lea                dstq, [dstq + dst_strideq*4]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %endif
   dec                   block_height
@@ -258,7 +268,7 @@ SECTION .text
   lea                srcq, [srcq + src_strideq*2]
   lea                dstq, [dstq + dst_strideq*2]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %else ; %1 < 16
   movu                 m0, [srcq]
@@ -270,7 +280,7 @@ SECTION .text
   pavgw                m1, m5
 %if %2 == 1 ; avg
   pavgw                m0, [secq]
-  add                secq, sec_str
+  add                secp, sec_str
   pavgw                m1, [secq]
 %endif
   SUM_SSE              m0, m2, m1, m3, m6, m7
@@ -278,7 +288,7 @@ SECTION .text
   lea                srcq, [srcq + src_strideq*4]
   lea                dstq, [dstq + dst_strideq*4]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %endif
   dec                   block_height
@@ -347,7 +357,7 @@ SECTION .text
   lea                srcq, [srcq + src_strideq*2]
   lea                dstq, [dstq + dst_strideq*2]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %else ; %1 < 16
   movu                 m0, [srcq]
@@ -368,7 +378,7 @@ SECTION .text
   psrlw                m0, 4
 %if %2 == 1 ; avg
   pavgw                m0, [secq]
-  add                secq, sec_str
+  add                secp, sec_str
   pavgw                m1, [secq]
 %endif
   SUM_SSE              m0, m2, m1, m3, m6, m7
@@ -376,7 +386,7 @@ SECTION .text
   lea                srcq, [srcq + src_strideq*4]
   lea                dstq, [dstq + dst_strideq*4]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %endif
   dec                   block_height
@@ -413,7 +423,7 @@ SECTION .text
   lea                srcq, [srcq + src_strideq*2]
   lea                dstq, [dstq + dst_strideq*2]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %else ; %1 < 16
   movu                 m0, [srcq]
@@ -426,7 +436,7 @@ SECTION .text
   pavgw                m1, m5
 %if %2 == 1 ; avg
   pavgw                m0, [secq]
-  add                secq, sec_str
+  add                secp, sec_str
   pavgw                m1, [secq]
 %endif
   SUM_SSE              m0, m2, m1, m3, m6, m7
@@ -434,7 +444,7 @@ SECTION .text
   lea                srcq, [srcq + src_strideq*4]
   lea                dstq, [dstq + dst_strideq*4]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %endif
   dec                   block_height
@@ -476,7 +486,7 @@ SECTION .text
   lea                srcq, [srcq + src_strideq*2]
   lea                dstq, [dstq + dst_strideq*2]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %else ; %1 < 16
   movu                 m0, [srcq]
@@ -496,7 +506,7 @@ SECTION .text
   mova                 m5, [dstq + dst_strideq*2]
 %if %2 == 1 ; avg
   pavgw                m0, [secq]
-  add                secq, sec_str
+  add                secp, sec_str
   pavgw                m2, [secq]
 %endif
   SUM_SSE              m0, m4, m2, m5, m6, m7
@@ -505,7 +515,7 @@ SECTION .text
   lea                srcq, [srcq + src_strideq*4]
   lea                dstq, [dstq + dst_strideq*4]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %endif
   dec                   block_height
@@ -582,7 +592,7 @@ SECTION .text
   lea                srcq, [srcq + src_strideq*2]
   lea                dstq, [dstq + dst_strideq*2]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %else ; %1 < 16
   movu                 m0, [srcq]
@@ -612,7 +622,7 @@ SECTION .text
   mova                 m3, [dstq+dst_strideq*2]
 %if %2 == 1 ; avg
   pavgw                m0, [secq]
-  add                secq, sec_str
+  add                secp, sec_str
   pavgw                m4, [secq]
 %endif
   SUM_SSE              m0, m2, m4, m3, m6, m7
@@ -621,7 +631,7 @@ SECTION .text
   lea                srcq, [srcq + src_strideq*4]
   lea                dstq, [dstq + dst_strideq*4]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %endif
   dec                   block_height
@@ -691,7 +701,7 @@ SECTION .text
   lea                srcq, [srcq+src_strideq*2]
   lea                dstq, [dstq+dst_strideq*2]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %else ; %1 < 16
   movu                 m0, [srcq]
@@ -712,7 +722,7 @@ SECTION .text
   psrlw                m0, 4
 %if %2 == 1 ; avg
   pavgw                m0, [secq]
-  add                secq, sec_str
+  add                secp, sec_str
   pavgw                m1, [secq]
 %endif
   SUM_SSE              m0, m4, m1, m5, m6, m7
@@ -720,7 +730,7 @@ SECTION .text
   lea                srcq, [srcq+src_strideq*4]
   lea                dstq, [dstq+dst_strideq*4]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %endif
   dec                   block_height
@@ -809,7 +819,7 @@ SECTION .text
   lea                srcq, [srcq+src_strideq*2]
   lea                dstq, [dstq+dst_strideq*2]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %else ; %1 < 16
   movu                 m0, [srcq]
@@ -841,7 +851,7 @@ SECTION .text
   pavgw                m2, m3
 %if %2 == 1 ; avg
   pavgw                m0, [secq]
-  add                secq, sec_str
+  add                secp, sec_str
   pavgw                m2, [secq]
 %endif
   SUM_SSE              m0, m4, m2, m5, m6, m7
@@ -850,7 +860,7 @@ SECTION .text
   lea                srcq, [srcq+src_strideq*4]
   lea                dstq, [dstq+dst_strideq*4]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %endif
   dec                   block_height
@@ -964,7 +974,7 @@ SECTION .text
   INC_SRC_BY_SRC_STRIDE
   lea                dstq, [dstq + dst_strideq * 2]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %else ; %1 < 16
   movu                 m0, [srcq]
@@ -1008,7 +1018,7 @@ SECTION .text
   mova                 m3, [dstq+dst_strideq*2]
 %if %2 == 1 ; avg
   pavgw                m0, [secq]
-  add                secq, sec_str
+  add                secp, sec_str
   pavgw                m4, [secq]
 %endif
   SUM_SSE              m0, m2, m4, m3, m6, m7
@@ -1017,7 +1027,7 @@ SECTION .text
   INC_SRC_BY_SRC_2STRIDE
   lea                dstq, [dstq + dst_strideq * 4]
 %if %2 == 1 ; avg
-  add                secq, sec_str
+  add                secp, sec_str
 %endif
 %endif
   dec                   block_height
diff --git a/vpx_dsp/x86/intrapred_sse2.asm b/vpx_dsp/x86/intrapred_sse2.asm
index 22b573188..253f0d241 100644
--- a/vpx_dsp/x86/intrapred_sse2.asm
+++ b/vpx_dsp/x86/intrapred_sse2.asm
@@ -27,6 +27,7 @@ INIT_MMX sse
 cglobal dc_predictor_4x4, 4, 5, 2, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn    strideq, stridep
   pxor                  m1, m1
   movd                  m0, [aboveq]
   punpckldq             m0, [leftq]
@@ -46,6 +47,8 @@ cglobal dc_predictor_4x4, 4, 5, 2, dst, stride, above, left, goffset
 
 INIT_MMX sse
 cglobal dc_left_predictor_4x4, 4, 5, 2, dst, stride, above, left, goffset
+  movsxdifnidn     strideq, stridep
+  movifnidn          leftp, leftmx
   GET_GOT     goffsetq
 
   pxor                  m1, m1
@@ -68,6 +71,7 @@ INIT_MMX sse
 cglobal dc_top_predictor_4x4, 4, 5, 2, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   movd                  m0, [aboveq]
   psadbw                m0, m1
@@ -88,6 +92,7 @@ INIT_MMX sse
 cglobal dc_predictor_8x8, 4, 5, 3, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   movq                  m0, [aboveq]
   movq                  m2, [leftq]
@@ -117,6 +122,7 @@ INIT_MMX sse
 cglobal dc_top_predictor_8x8, 4, 5, 3, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   movq                  m0, [aboveq]
   DEFINE_ARGS dst, stride, stride3
@@ -141,6 +147,8 @@ cglobal dc_top_predictor_8x8, 4, 5, 3, dst, stride, above, left, goffset
 
 INIT_MMX sse
 cglobal dc_left_predictor_8x8, 4, 5, 3, dst, stride, above, left, goffset
+  movsxdifnidn     strideq, stridep
+  movifnidn          leftp, leftmx
   GET_GOT     goffsetq
 
   pxor                  m1, m1
@@ -169,6 +177,7 @@ INIT_MMX sse
 cglobal dc_128_predictor_4x4, 4, 5, 3, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   DEFINE_ARGS dst, stride, stride3
   lea             stride3q, [strideq*3]
   movd     m0,        [GLOBAL(dc_128)]
@@ -183,6 +192,7 @@ INIT_MMX sse
 cglobal dc_128_predictor_8x8, 4, 5, 3, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   DEFINE_ARGS dst, stride, stride3
   lea             stride3q, [strideq*3]
   movq    m0,        [GLOBAL(dc_128)]
@@ -202,6 +212,7 @@ INIT_XMM sse2
 cglobal dc_predictor_16x16, 4, 5, 3, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   mova                  m0, [aboveq]
   mova                  m2, [leftq]
@@ -235,6 +246,7 @@ INIT_XMM sse2
 cglobal dc_top_predictor_16x16, 4, 5, 3, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   pxor                  m2, m2
   mova                  m0, [aboveq]
@@ -267,6 +279,7 @@ INIT_XMM sse2
 cglobal dc_left_predictor_16x16, 4, 5, 3, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   pxor                  m2, m2
   mova                  m0, [leftq]
@@ -299,6 +312,7 @@ INIT_XMM sse2
 cglobal dc_128_predictor_16x16, 4, 5, 3, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   DEFINE_ARGS dst, stride, stride3, lines4
   lea             stride3q, [strideq*3]
   mov              lines4d, 4
@@ -319,6 +333,7 @@ INIT_XMM sse2
 cglobal dc_predictor_32x32, 4, 5, 5, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   mova                  m0, [aboveq]
   mova                  m2, [aboveq+16]
@@ -361,6 +376,7 @@ INIT_XMM sse2
 cglobal dc_top_predictor_32x32, 4, 5, 5, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   mova                  m0, [aboveq]
   mova                  m2, [aboveq+16]
@@ -397,6 +413,7 @@ INIT_XMM sse2
 cglobal dc_left_predictor_32x32, 4, 5, 5, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   mova                  m0, [leftq]
   mova                  m2, [leftq+16]
@@ -433,6 +450,7 @@ INIT_XMM sse2
 cglobal dc_128_predictor_32x32, 4, 5, 3, dst, stride, above, left, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn     strideq, stridep
   DEFINE_ARGS dst, stride, stride3, lines4
   lea             stride3q, [strideq*3]
   mov              lines4d, 8
@@ -454,6 +472,7 @@ cglobal dc_128_predictor_32x32, 4, 5, 3, dst, stride, above, left, goffset
 
 INIT_MMX sse
 cglobal v_predictor_4x4, 3, 3, 1, dst, stride, above
+  movsxdifnidn     strideq, stridep
   movd                  m0, [aboveq]
   movd      [dstq        ], m0
   movd      [dstq+strideq], m0
@@ -464,6 +483,7 @@ cglobal v_predictor_4x4, 3, 3, 1, dst, stride, above
 
 INIT_MMX sse
 cglobal v_predictor_8x8, 3, 3, 1, dst, stride, above
+  movsxdifnidn     strideq, stridep
   movq                  m0, [aboveq]
   DEFINE_ARGS dst, stride, stride3
   lea             stride3q, [strideq*3]
@@ -480,6 +500,7 @@ cglobal v_predictor_8x8, 3, 3, 1, dst, stride, above
 
 INIT_XMM sse2
 cglobal v_predictor_16x16, 3, 4, 1, dst, stride, above
+  movsxdifnidn     strideq, stridep
   mova                  m0, [aboveq]
   DEFINE_ARGS dst, stride, stride3, nlines4
   lea             stride3q, [strideq*3]
@@ -496,6 +517,7 @@ cglobal v_predictor_16x16, 3, 4, 1, dst, stride, above
 
 INIT_XMM sse2
 cglobal v_predictor_32x32, 3, 4, 2, dst, stride, above
+  movsxdifnidn     strideq, stridep
   mova                  m0, [aboveq]
   mova                  m1, [aboveq+16]
   DEFINE_ARGS dst, stride, stride3, nlines4
@@ -517,6 +539,7 @@ cglobal v_predictor_32x32, 3, 4, 2, dst, stride, above
 
 INIT_MMX sse
 cglobal tm_predictor_4x4, 4, 4, 4, dst, stride, above, left
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   movd                  m2, [aboveq-1]
   movd                  m0, [aboveq]
@@ -547,6 +570,7 @@ cglobal tm_predictor_4x4, 4, 4, 4, dst, stride, above, left
 
 INIT_XMM sse2
 cglobal tm_predictor_8x8, 4, 4, 4, dst, stride, above, left
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   movd                  m2, [aboveq-1]
   movq                  m0, [aboveq]
@@ -579,6 +603,7 @@ cglobal tm_predictor_8x8, 4, 4, 4, dst, stride, above, left
 
 INIT_XMM sse2
 cglobal tm_predictor_16x16, 4, 4, 7, dst, stride, above, left
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   movd                  m2, [aboveq-1]
   mova                  m0, [aboveq]
@@ -617,6 +642,7 @@ cglobal tm_predictor_16x16, 4, 4, 7, dst, stride, above, left
 %if ARCH_X86_64
 INIT_XMM sse2
 cglobal tm_predictor_32x32, 4, 4, 10, dst, stride, above, left
+  movsxdifnidn     strideq, stridep
   pxor                  m1, m1
   movd                  m2, [aboveq-1]
   mova                  m0, [aboveq]
diff --git a/vpx_dsp/x86/intrapred_ssse3.asm b/vpx_dsp/x86/intrapred_ssse3.asm
index 88df9b2d1..a14e14a17 100644
--- a/vpx_dsp/x86/intrapred_ssse3.asm
+++ b/vpx_dsp/x86/intrapred_ssse3.asm
@@ -177,6 +177,7 @@ INIT_XMM ssse3
 cglobal d45_predictor_16x16, 3, 6, 4, dst, stride, above, dst8, line, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn      strideq, stridep
   mova                   m0, [aboveq]
   DEFINE_ARGS dst, stride, stride3, dst8, line
   lea              stride3q, [strideq*3]
@@ -228,6 +229,7 @@ INIT_XMM ssse3
 cglobal d45_predictor_32x32, 3, 6, 7, dst, stride, above, dst16, line, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn      strideq, stridep
   mova                   m0, [aboveq]
   mova                   m4, [aboveq+16]
   DEFINE_ARGS dst, stride, stride3, dst16, line
@@ -323,6 +325,7 @@ INIT_XMM ssse3
 cglobal d63_predictor_4x4, 3, 4, 5, dst, stride, above, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn   strideq, stridep
   movq                m3, [aboveq]
   pshufb              m1, m3, [GLOBAL(sh_b23456777)]
   pshufb              m2, m3, [GLOBAL(sh_b12345677)]
@@ -345,6 +348,7 @@ INIT_XMM ssse3
 cglobal d63_predictor_8x8, 3, 4, 5, dst, stride, above, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn   strideq, stridep
   movq                m3, [aboveq]
   DEFINE_ARGS dst, stride, stride3
   lea           stride3q, [strideq*3]
@@ -381,6 +385,7 @@ INIT_XMM ssse3
 cglobal d63_predictor_16x16, 3, 5, 5, dst, stride, above, line, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn   strideq, stridep
   mova                m0, [aboveq]
   DEFINE_ARGS dst, stride, stride3, line
   lea           stride3q, [strideq*3]
@@ -411,6 +416,7 @@ INIT_XMM ssse3
 cglobal d63_predictor_32x32, 3, 5, 8, dst, stride, above, line, goffset
   GET_GOT     goffsetq
 
+  movsxdifnidn      strideq, stridep
   mova                   m0, [aboveq]
   mova                   m7, [aboveq+16]
   DEFINE_ARGS dst, stride, stride3, line
@@ -455,6 +461,7 @@ cglobal d63_predictor_32x32, 3, 5, 8, dst, stride, above, line, goffset
 INIT_XMM ssse3
 cglobal d153_predictor_4x4, 4, 5, 4, dst, stride, above, left, goffset
   GET_GOT     goffsetq
+  movsxdifnidn   strideq, stridep
   movd                m0, [leftq]               ; l1, l2, l3, l4
   movd                m1, [aboveq-1]            ; tl, t1, t2, t3
   punpckldq           m0, m1                    ; l1, l2, l3, l4, tl, t1, t2, t3
@@ -487,6 +494,7 @@ cglobal d153_predictor_4x4, 4, 5, 4, dst, stride, above, left, goffset
 INIT_XMM ssse3
 cglobal d153_predictor_8x8, 4, 5, 8, dst, stride, above, left, goffset
   GET_GOT     goffsetq
+  movsxdifnidn   strideq, stridep
   movq                m0, [leftq]                     ; [0- 7] l1-8 [byte]
   movhps              m0, [aboveq-1]                  ; [8-15] tl, t1-7 [byte]
   pshufb              m1, m0, [GLOBAL(sh_b76543210)]  ; l8-1 [word]
@@ -536,6 +544,7 @@ cglobal d153_predictor_8x8, 4, 5, 8, dst, stride, above, left, goffset
 INIT_XMM ssse3
 cglobal d153_predictor_16x16, 4, 5, 8, dst, stride, above, left, goffset
   GET_GOT     goffsetq
+  movsxdifnidn   strideq, stridep
   mova                m0, [leftq]
   movu                m7, [aboveq-1]
   ; comments below are for a predictor like this
@@ -615,6 +624,7 @@ cglobal d153_predictor_16x16, 4, 5, 8, dst, stride, above, left, goffset
 INIT_XMM ssse3
 cglobal d153_predictor_32x32, 4, 5, 8, dst, stride, above, left, goffset
   GET_GOT     goffsetq
+  movsxdifnidn     strideq, stridep
   mova                  m0, [leftq]
   movu                  m7, [aboveq-1]
   movu                  m1, [aboveq+15]
@@ -814,6 +824,7 @@ cglobal d207_predictor_4x4, 4, 5, 4, dst, stride, unused, left, goffset
 INIT_XMM ssse3
 cglobal d207_predictor_8x8, 4, 5, 4, dst, stride, stride3, left, goffset
   GET_GOT     goffsetq
+  movsxdifnidn   strideq, stridep
   movq                m3, [leftq]            ; abcdefgh [byte]
   lea           stride3q, [strideq*3]
 
@@ -848,6 +859,7 @@ cglobal d207_predictor_8x8, 4, 5, 4, dst, stride, stride3, left, goffset
 INIT_XMM ssse3
 cglobal d207_predictor_16x16, 4, 5, 5, dst, stride, stride3, left, goffset
   GET_GOT     goffsetq
+  movsxdifnidn   strideq, stridep
   lea           stride3q, [strideq*3]
   mova                m0, [leftq]            ; abcdefghijklmnop [byte]
   pshufb              m1, m0, [GLOBAL(sh_b123456789abcdeff)] ; bcdefghijklmnopp
@@ -895,6 +907,7 @@ cglobal d207_predictor_16x16, 4, 5, 5, dst, stride, stride3, left, goffset
 INIT_XMM ssse3
 cglobal d207_predictor_32x32, 4, 5, 8, dst, stride, stride3, left, goffset
   GET_GOT     goffsetq
+  movsxdifnidn   strideq, stridep
   lea           stride3q, [strideq*3]
   mova                m1, [leftq]              ;  0-15 [byte]
   mova                m2, [leftq+16]           ; 16-31 [byte]
diff --git a/vpx_dsp/x86/inv_wht_sse2.asm b/vpx_dsp/x86/inv_wht_sse2.asm
index df6f4692b..58ee25281 100644
--- a/vpx_dsp/x86/inv_wht_sse2.asm
+++ b/vpx_dsp/x86/inv_wht_sse2.asm
@@ -82,6 +82,7 @@ SECTION .text
 
 INIT_XMM sse2
 cglobal iwht4x4_16_add, 3, 3, 7, input, output, stride
+  movsxdifnidn strideq, stridep
   mova            m0,        [inputq +  0]
   mova            m1,        [inputq + 16]
 
diff --git a/vpx_dsp/x86/sad4d_sse2.asm b/vpx_dsp/x86/sad4d_sse2.asm
index a2f0ae79e..d4622a51f 100644
--- a/vpx_dsp/x86/sad4d_sse2.asm
+++ b/vpx_dsp/x86/sad4d_sse2.asm
@@ -181,10 +181,10 @@ cglobal sad%1x%2x4d, 4, 7, 8, src, src_stride, ref1, ref_stride, \
 %endif
   movsxdifnidn src_strideq, src_strided
   movsxdifnidn ref_strideq, ref_strided
-  mov                ref2q, [ref1q+gprsize*1]
-  mov                ref3q, [ref1q+gprsize*2]
-  mov                ref4q, [ref1q+gprsize*3]
-  mov                ref1q, [ref1q+gprsize*0]
+  mov                ref2p, [ref1q+ptrsize*1]
+  mov                ref3p, [ref1q+ptrsize*2]
+  mov                ref4p, [ref1q+ptrsize*3]
+  mov                ref1p, [ref1q+ptrsize*0]
 
   PROCESS_%1x2x4 1, 0, 0, src_strideq, ref_strideq, 1
 %rep (%2-4)/2
@@ -201,14 +201,14 @@ cglobal sad%1x%2x4d, 4, 7, 8, src, src_stride, ref1, ref_stride, \
   mova                  m7, m6
   punpcklqdq            m4, m6
   punpckhqdq            m5, m7
-  movifnidn             r4, r4mp
+  movifnidn            r4p, r4mx
   paddd                 m4, m5
   movu                [r4], m4
   RET
 %else
-  movifnidn             r4, r4mp
-  movq               [r4+0], m6
-  movq               [r4+8], m7
+  movifnidn            r4p, r4mx
+  movq              [r4+0], m6
+  movq              [r4+8], m7
   RET
 %endif
 %endmacro
diff --git a/vpx_dsp/x86/ssim_opt_x86_64.asm b/vpx_dsp/x86/ssim_opt_x86_64.asm
index 6d58321e0..a296301b0 100644
--- a/vpx_dsp/x86/ssim_opt_x86_64.asm
+++ b/vpx_dsp/x86/ssim_opt_x86_64.asm
@@ -119,11 +119,11 @@ sym(vpx_ssim_parms_16x16_sse2):
     movd            [rdi], xmm15;
     mov             rdi,arg(5)
     movd            [rdi], xmm14;
-    mov             rdi,arg(6)
+    mov             rdip,arg(6)
     movd            [rdi], xmm13;
-    mov             rdi,arg(7)
+    mov             rdip,arg(7)
     movd            [rdi], xmm12;
-    mov             rdi,arg(8)
+    mov             rdip,arg(8)
     movd            [rdi], xmm11;
 
     ; begin epilog
@@ -200,11 +200,11 @@ sym(vpx_ssim_parms_8x8_sse2):
     movd            [rdi], xmm15;
     mov             rdi,arg(5)
     movd            [rdi], xmm14;
-    mov             rdi,arg(6)
+    mov             rdip,arg(6)
     movd            [rdi], xmm13;
-    mov             rdi,arg(7)
+    mov             rdip,arg(7)
     movd            [rdi], xmm12;
-    mov             rdi,arg(8)
+    mov             rdip,arg(8)
     movd            [rdi], xmm11;
 
     ; begin epilog
diff --git a/vpx_dsp/x86/subpel_variance_sse2.asm b/vpx_dsp/x86/subpel_variance_sse2.asm
index 05dcff75e..13e37c7fd 100644
--- a/vpx_dsp/x86/subpel_variance_sse2.asm
+++ b/vpx_dsp/x86/subpel_variance_sse2.asm
@@ -121,12 +121,19 @@ SECTION .text
                                       dst, dst_stride, \
                                       sec, sec_stride, height, sse
     %define sec_str sec_strideq
+    %if ABI_X32
+      mov secp, secp
+      movsxd sec_strideq, sec_stridep
+    %endif
   %else
     cglobal sub_pixel_variance%1xh, 7, 8, 13, src, src_stride, x_offset, \
                                   y_offset, dst, dst_stride, height, sse
   %endif
   %define block_height heightd
   %define bilin_filter sseq
+  %if ABI_X32
+    mov ssep, ssep
+  %endif
 %else
   %if ARCH_X86=1 && CONFIG_PIC=1
     %if %2 == 1 ; avg
@@ -192,6 +199,9 @@ SECTION .text
   %endif
 %endif
 
+  movsxdifnidn src_strideq, src_stridep
+  movsxdifnidn dst_strideq, dst_stridep
+
   ASSERT               %1 <= 16         ; m6 overflows if w > 16
   pxor                 m6, m6           ; sum
   pxor                 m7, m7           ; sse
diff --git a/vpx_dsp/x86/subtract_sse2.asm b/vpx_dsp/x86/subtract_sse2.asm
index 4273efb85..19279b40a 100644
--- a/vpx_dsp/x86/subtract_sse2.asm
+++ b/vpx_dsp/x86/subtract_sse2.asm
@@ -21,6 +21,8 @@ INIT_XMM sse2
 cglobal subtract_block, 7, 7, 8, \
                         rows, cols, diff, diff_stride, src, src_stride, \
                         pred, pred_stride
+  movsxdifnidn diff_strideq, diff_stridep
+  movsxdifnidn  src_strideq, src_stridep
 %define pred_str colsq
   pxor                  m7, m7         ; dedicated zero register
   cmp                colsd, 4
@@ -55,7 +57,7 @@ cglobal subtract_block, 7, 7, 8, \
   mova [diffq+mmsize*1+%6], m1
 %endmacro
 
-  mov             pred_str, pred_stridemp
+  movsxpq         pred_str, pred_stridemx
 .loop_64:
   loop16 0*mmsize, 1*mmsize, 0*mmsize, 1*mmsize, 0*mmsize, 2*mmsize
   loop16 2*mmsize, 3*mmsize, 2*mmsize, 3*mmsize, 4*mmsize, 6*mmsize
@@ -67,7 +69,7 @@ cglobal subtract_block, 7, 7, 8, \
   RET
 
 .case_32:
-  mov             pred_str, pred_stridemp
+  movsxpq         pred_str, pred_stridemx
 .loop_32:
   loop16 0, mmsize, 0, mmsize, 0, 2*mmsize
   lea                diffq, [diffq+diff_strideq*2]
@@ -78,7 +80,7 @@ cglobal subtract_block, 7, 7, 8, \
   RET
 
 .case_16:
-  mov             pred_str, pred_stridemp
+  movsxpq         pred_str, pred_stridemx
 .loop_16:
   loop16 0, src_strideq, 0, pred_str, 0, diff_strideq*2
   lea                diffq, [diffq+diff_strideq*4]
@@ -104,7 +106,7 @@ cglobal subtract_block, 7, 7, 8, \
 %endmacro
 
 .case_8:
-  mov             pred_str, pred_stridemp
+  movsxpq         pred_str, pred_stridemx
 .loop_8:
   loop_h
   lea                diffq, [diffq+diff_strideq*4]
@@ -116,7 +118,7 @@ cglobal subtract_block, 7, 7, 8, \
 
 INIT_MMX
 .case_4:
-  mov             pred_str, pred_stridemp
+  movsxpq         pred_str, pred_stridemx
 .loop_4:
   loop_h
   lea                diffq, [diffq+diff_strideq*4]
diff --git a/vpx_dsp/x86/vpx_convolve_copy_sse2.asm b/vpx_dsp/x86/vpx_convolve_copy_sse2.asm
index 9c5b414b4..d73d23092 100644
--- a/vpx_dsp/x86/vpx_convolve_copy_sse2.asm
+++ b/vpx_dsp/x86/vpx_convolve_copy_sse2.asm
@@ -23,6 +23,8 @@ cglobal %2_convolve_%1, 4, 7, 4, src, src_stride, dst, dst_stride, \
 cglobal convolve_%1, 4, 7, 4, src, src_stride, dst, dst_stride, \
                               fx, fxs, fy, fys, w, h
 %endif
+  movsxdifnidn src_strideq, src_stridep
+  movsxdifnidn dst_strideq, dst_stridep
   mov r4d, dword wm
 %ifidn %2, highbd
   shl r4d, 1
diff --git a/vpx_dsp/x86/vpx_subpixel_8t_ssse3.asm b/vpx_dsp/x86/vpx_subpixel_8t_ssse3.asm
index 3fbaa274c..a7bd8d108 100644
--- a/vpx_dsp/x86/vpx_subpixel_8t_ssse3.asm
+++ b/vpx_dsp/x86/vpx_subpixel_8t_ssse3.asm
@@ -98,6 +98,8 @@ SECTION .text
 %macro SUBPIX_HFILTER4 1
 cglobal filter_block1d4_%1, 6, 6+(ARCH_X86_64*2), 11, LOCAL_VARS_SIZE, \
                             src, sstride, dst, dstride, height, filter
+    movsxdifnidn  sstrideq, sstridep
+    movsxdifnidn  dstrideq, dstridep
     mova                m4, [filterq]
     packsswb            m4, m4
 %if ARCH_X86_64
@@ -256,6 +258,8 @@ cglobal filter_block1d4_%1, 6, 6+(ARCH_X86_64*2), 11, LOCAL_VARS_SIZE, \
 %macro SUBPIX_HFILTER8 1
 cglobal filter_block1d8_%1, 6, 6+(ARCH_X86_64*1), 14, LOCAL_VARS_SIZE, \
                             src, sstride, dst, dstride, height, filter
+    movsxdifnidn  sstrideq, sstridep
+    movsxdifnidn  dstrideq, dstridep
     mova                 m4, [filterq]
     SETUP_LOCAL_VARS
 %if ARCH_X86_64
@@ -363,6 +367,8 @@ cglobal filter_block1d8_%1, 6, 6+(ARCH_X86_64*1), 14, LOCAL_VARS_SIZE, \
 %macro SUBPIX_HFILTER16 1
 cglobal filter_block1d16_%1, 6, 6+(ARCH_X86_64*0), 14, LOCAL_VARS_SIZE, \
                              src, sstride, dst, dstride, height, filter
+    movsxdifnidn  sstrideq, sstridep
+    movsxdifnidn  dstrideq, dstridep
     mova          m4, [filterq]
     SETUP_LOCAL_VARS
 .loop:
@@ -444,6 +450,8 @@ SUBPIX_HFILTER4  h8_avg
 %macro SUBPIX_VFILTER 2
 cglobal filter_block1d%2_%1, 6, 6+(ARCH_X86_64*3), 14, LOCAL_VARS_SIZE, \
                              src, sstride, dst, dstride, height, filter
+    movsxdifnidn sstrideq, sstridep
+    movsxdifnidn dstrideq, dstridep
     mova          m4, [filterq]
     SETUP_LOCAL_VARS
 %if ARCH_X86_64
@@ -573,6 +581,8 @@ cglobal filter_block1d%2_%1, 6, 6+(ARCH_X86_64*3), 14, LOCAL_VARS_SIZE, \
 cglobal filter_block1d16_%1, 6, 6+(ARCH_X86_64*3), 14, LOCAL_VARS_SIZE, \
                              src, sstride, dst, dstride, height, filter
 
+    movsxdifnidn   sstrideq, sstridep
+    movsxdifnidn   dstrideq, dstridep
     mova          m4, [filterq]
     SETUP_LOCAL_VARS
 %if ARCH_X86_64
-- 
2.16.4

